<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pelichet â€” ContrÃ´le QualitÃ©</title>

  <!-- Couleur dâ€™UI navigateur -->
  <meta name="theme-color" content="#ff6a00" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-32.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="icon-180.png" />

  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Librairies (chart + zxing + HEIC) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
</head>
<body>
  <!-- Appbar / Header -->
  <header class="appbar">
    <img class="logo" src="icon-180.png" alt="Pelichet" />
    <h1>Pelichet â€” ContrÃ´le QualitÃ©</h1>
    <div class="spacer"></div>
    <button id="themeToggle" class="icon-btn" title="Clair/Sombre">ðŸŒ“</button>
  </header>

  <!-- Tabs -->
  <nav id="tabs" class="tabs">
    <button class="tab active" data-target="tabCartons">Cartons</button>
    <button class="tab" data-target="tabPA">Palettes Avant</button>
    <button class="tab" data-target="tabPD">Palettes Destination</button>
    <button class="tab" data-target="tabKPI">KPI</button>
  </nav>

  <main class="wrap grid">
    <!-- ========== CARTONS ========== -->
    <section id="tabCartons" class="tabContent active">
      <div class="card grid">
        <h2>ContrÃ´le des Cartons</h2>
        <form id="formCartons" class="qcForm grid" data-type="Cartons" autocomplete="off">
          <div class="row">
            <label>Date</label>
            <input type="date" name="date_saisie" required />
          </div>

          <div class="row">
            <label>Code-barres</label>
            <div class="hstack">
              <input id="cartons_code" name="code_barres" type="text" inputmode="numeric" required />
              <button type="button" class="btn" data-scan="cartons_code">ðŸ“· Scanner</button>
            </div>
            <small>ou</small>
            <input type="file" class="barcode-photo" data-target="cartons_code" accept="image/*" capture="environment" />
          </div>

          <div class="row">
            <label>Photo principale</label>
            <input type="file" name="photo_principale" accept="image/*" capture="environment" />
          </div>

          <div class="grid">
            <div class="qblock">
              <label>Callage papier correct ?</label>
              <select name="callage_papier">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="callage_papier_photos" accept="image/*" capture="environment" multiple />
                <textarea name="callage_papier_commentaire" placeholder="DÃ©crire le problÃ¨me"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Intercalaires prÃ©sents ?</label>
              <select name="intercalaires_livres">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="intercalaires_livres_photos" accept="image/*" capture="environment" multiple />
                <textarea name="intercalaires_livres_commentaire" placeholder="DÃ©crire le problÃ¨me"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Ordre & disposition respectÃ©s ?</label>
              <select name="ordre_colonnes">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="ordre_colonnes_photos" accept="image/*" capture="environment" multiple />
                <textarea name="ordre_colonnes_commentaire" placeholder="DÃ©crire le problÃ¨me"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Scotch bien appliquÃ© ?</label>
              <select name="scotch">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="scotch_photos" accept="image/*" capture="environment" multiple />
                <textarea name="scotch_commentaire" placeholder="DÃ©crire le problÃ¨me"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Livres dÃ©poussiÃ©rÃ©s ?</label>
              <select name="depoussierage">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="depoussierage_photos" accept="image/*" capture="environment" multiple />
                <textarea name="depoussierage_commentaire" placeholder="DÃ©crire le problÃ¨me"></textarea>
              </div>
            </div>
          </div>

          <button type="submit" class="btn primary">ðŸ“¤ Envoyer</button>
        </form>
      </div>
    </section>

    <!-- ========== PALETTES AVANT ========== -->
    <section id="tabPA" class="tabContent">
      <div class="card grid">
        <h2>Palettes (Avant camion)</h2>
        <form id="formPA" class="qcForm grid" data-type="Palettes_Avant" autocomplete="off">
          <div class="row">
            <label>Date</label>
            <input type="date" name="date_saisie" required />
          </div>

          <div class="row">
            <label>Code-barres palette</label>
            <div class="hstack">
              <input id="pa_code" name="code_barres" type="text" required />
              <button type="button" class="btn" data-scan="pa_code">ðŸ“· Scanner</button>
            </div>
            <small>ou</small>
            <input type="file" class="barcode-photo" data-target="pa_code" accept="image/*" capture="environment" />
          </div>

          <div class="row">
            <label>Photo principale</label>
            <input type="file" name="photo_principale" accept="image/*" capture="environment" />
          </div>

          <div class="grid">
            <div class="qblock">
              <label>Cartons en bon Ã©tat ?</label>
              <select name="cartons_etat">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="cartons_etat_photos" accept="image/*" capture="environment" multiple />
                <textarea name="cartons_etat_commentaire"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Intercalaires prÃ©sents ?</label>
              <select name="intercalaires_cartons">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="intercalaires_cartons_photos" accept="image/*" capture="environment" multiple />
                <textarea name="intercalaires_cartons_commentaire"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Ordre des cartons respectÃ© ?</label>
              <select name="ordre_cartons">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="ordre_cartons_photos" accept="image/*" capture="environment" multiple />
                <textarea name="ordre_cartons_commentaire"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Cerclage bien appliquÃ© ?</label>
              <select name="cerclage">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="cerclage_photos" accept="image/*" capture="environment" multiple />
                <textarea name="cerclage_commentaire"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Palette stable ?</label>
              <select name="stabilite">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="stabilite_photos" accept="image/*" capture="environment" multiple />
                <textarea name="stabilite_commentaire"></textarea>
              </div>
            </div>
          </div>

          <button type="submit" class="btn primary">ðŸ“¤ Envoyer</button>
        </form>
      </div>
    </section>

    <!-- ========== PALETTES DESTINATION ========== -->
    <section id="tabPD" class="tabContent">
      <div class="card grid">
        <h2>Palettes (Destination)</h2>
        <form id="formPD" class="qcForm grid" data-type="Palettes_Destination" autocomplete="off">
          <div class="row">
            <label>Date</label>
            <input type="date" name="date_saisie" required />
          </div>

          <div class="row">
            <label>Code-barres palette</label>
            <div class="hstack">
              <input id="pd_code" name="code_barres" type="text" required />
              <button type="button" class="btn" data-scan="pd_code">ðŸ“· Scanner</button>
            </div>
            <small>ou</small>
            <input type="file" class="barcode-photo" data-target="pd_code" accept="image/*" capture="environment" />
          </div>

          <div class="row">
            <label>Photo principale</label>
            <input type="file" name="photo_principale" accept="image/*" capture="environment" />
          </div>

          <div class="grid">
            <div class="qblock">
              <label>Cartons en bon Ã©tat ?</label>
              <select name="cartons_etat">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="cartons_etat_photos" accept="image/*" capture="environment" multiple />
                <textarea name="cartons_etat_commentaire"></textarea>
              </div>
            </div>

            <div class="qblock">
              <label>Cerclage bien appliquÃ© ?</label>
              <select name="cerclage">
                <option value="OK" selected>OK</option><option value="KO">Pas OK</option>
              </select>
              <div class="koDetails hidden grid">
                <input type="file" name="cerclage_photos" accept="image/*" capture="environment" multiple />
                <textarea name="cerclage_commentaire"></textarea>
              </div>
            </div>
          </div>

          <button type="submit" class="btn primary">ðŸ“¤ Envoyer</button>
        </form>
      </div>
    </section>

    <!-- ========== KPI ========== -->
    <section id="tabKPI" class="tabContent">
      <div class="card grid">
        <h2>Tableau de bord KPI</h2>
        <div class="hstack">
          <button id="btnKpiRefresh" class="btn">ðŸ”„ RafraÃ®chir</button>
        </div>
        <div id="kpiResults" class="kpi">â€”</div>
      </div>
    </section>
  </main>

  <!-- MODAL SCANNER -->
  <div id="scannerModal" class="scanner-modal" aria-hidden="true" style="display:none">
    <div class="scanner-box">
      <h3>Scanner le code-barres</h3>
      <video id="scannerVideo" playsinline autoplay muted></video>
      <div class="scanner-actions">
        <button id="scannerStart" class="btn primary" type="button">DÃ©marrer</button>
        <button id="scannerStop" class="btn" type="button">ArrÃªter</button>
        <button id="scannerClose" class="btn" type="button">Fermer</button>
      </div>
      <p class="hint">Autoriser la camÃ©ra (Safari/Chrome). Cadrez Ã  15â€“25 cm, bonne lumiÃ¨re.</p>
    </div>
  </div>

  <!-- LOADER GLOBAL (avec barre indÃ©terminÃ©e) -->
  <div id="globalLoader" style="display:none">
    <div class="box">
      <div class="spin"></div>
      <div id="loaderMsg">Traitement en coursâ€¦</div>
      <div style="margin-top:10px;background:#333;border-radius:8px;height:10px;overflow:hidden">
        <div id="loaderBar" style="width:40%;height:100%;background:#ff6a00;animation:loader-move 1.1s linear infinite"></div>
      </div>
    </div>
  </div>
  <style>
    @keyframes loader-move {
      0% { transform: translateX(-120%); }
      100% { transform: translateX(220%); }
    }
  </style>

  <!-- App -->
  <script src="app.js"></script>
  <script>
    // Enregistrer le service worker PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
