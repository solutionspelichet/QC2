<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ff6a00" />
  <title>Pelichet QC ‚Äì Contr√¥le Qualit√©</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-32.png" />
  <link rel="apple-touch-icon" href="icon-180.png" />
  <link rel="stylesheet" href="style.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <!-- Config inline (peut √™tre remplac√©e par config.json) -->
  <script>
    window.CONFIG = {
      WEBAPP_BASE_URL: "https://script.google.com/macros/s/AKfycbztRuXNCGGHlXG3BiSRPXJdo7OThM1kfw1BBdP1VXxRgHPa9QGpWDCz0HIeBCDWN3Uq/exec",
      RESIZE_ENABLED: true,
      MAX_IMAGE_DIM: 1600,
      OUTPUT_MIME: "image/jpeg",
      QUALITY: 0.85,
      MAX_FILE_SIZE_KB: 600
    };
  </script>
</head>

<body>
  <header class="app-header">
    <img src="icon-180.png" alt="Pelichet" class="logo" />
    <h1>Pelichet QC</h1>
    <button id="toggleTheme" class="btn" title="Clair / Sombre">‚òÄÔ∏è/üåô</button>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="Cartons">Cartons</button>
    <button class="tab" data-tab="Palettes_Avant">Palettes Avant</button>
    <button class="tab" data-tab="Palettes_Destination">Palettes Destination</button>
    <button class="tab" data-tab="KPI">KPI</button>
  </nav>

  <main>
    <!-- CARTONS -->
    <section id="tab-Cartons" class="tab-pane active">
      <h2>Contr√¥le des Cartons</h2>
      <form class="qc-form" data-type="Cartons">
        <div class="row">
          <label>Date du jour</label>
          <input type="date" name="date_jour" required />
        </div>

        <div class="row">
          <label>Code-barres</label>
          <div class="hstack">
            <input id="cartons_code" name="code_barres" type="text" inputmode="numeric" required />
            <button type="button" class="btn" data-scan="cartons_code">Scanner</button>
          </div>
        </div>

        <div class="row">
          <label>Photo principale</label>
          <div class="hstack">
            <button id="btnCartonsPhotoCam" type="button" class="btn">Cam√©ra</button>
            <button id="btnCartonsPhotoGal" type="button" class="btn">Galerie</button>
            <span id="cartons_photo_label" class="muted">Aucune</span>
          </div>
          <!-- paires r√©elles cach√©es + cible -->
          <input id="cartons_photo_cam" type="file" accept="image/*" capture="environment" hidden />
          <input id="cartons_photo_gal" type="file" accept="image/*" hidden />
          <input id="cartons_photo_target" name="photo_principale" type="file" accept="image/*" hidden />
        </div>

        <fieldset>
          <legend>Questions</legend>

          <div class="qblock">
            <label>Callage papier correct ?</label>
            <div class="okko">
              <label><input type="radio" name="callage_papier" value="OK" checked> OK</label>
              <label><input type="radio" name="callage_papier" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="callage_papier">
              <input type="file" data-photofor="callage_papier" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="callage_papier" placeholder="D√©crire le probl√®me"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Intercalaires pr√©sents ?</label>
            <div class="okko">
              <label><input type="radio" name="intercalaires_livres" value="OK" checked> OK</label>
              <label><input type="radio" name="intercalaires_livres" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="intercalaires_livres">
              <input type="file" data-photofor="intercalaires_livres" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="intercalaires_livres" placeholder="D√©crire le probl√®me"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Ordre/disposition respect√©s ?</label>
            <div class="okko">
              <label><input type="radio" name="ordre_colonnes" value="OK" checked> OK</label>
              <label><input type="radio" name="ordre_colonnes" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="ordre_colonnes">
              <input type="file" data-photofor="ordre_colonnes" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="ordre_colonnes" placeholder="D√©crire le probl√®me"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Scotch bien appliqu√© ?</label>
            <div class="okko">
              <label><input type="radio" name="scotch" value="OK" checked> OK</label>
              <label><input type="radio" name="scotch" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="scotch">
              <input type="file" data-photofor="scotch" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="scotch" placeholder="D√©crire le probl√®me"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Livres d√©poussi√©r√©s ?</label>
            <div class="okko">
              <label><input type="radio" name="depoussierage" value="OK" checked> OK</label>
              <label><input type="radio" name="depoussierage" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="depoussierage">
              <input type="file" data-photofor="depoussierage" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="depoussierage" placeholder="D√©crire le probl√®me"></textarea>
            </div>
          </div>
        </fieldset>

        <div class="actions">
          <button class="btn primary" type="submit">üì§ Envoyer</button>
          <span class="result"></span>
        </div>
      </form>
    </section>

    <!-- PALETTES AVANT -->
    <section id="tab-Palettes_Avant" class="tab-pane">
      <h2>Contr√¥le des Palettes (Avant camion)</h2>
      <form class="qc-form" data-type="Palettes_Avant">
        <div class="row">
          <label>Date du jour</label>
          <input type="date" name="date_jour" required />
        </div>

        <div class="row">
          <label>Code-barres palette</label>
          <div class="hstack">
            <input id="pa_code" name="code_barres" type="text" required />
            <button type="button" class="btn" data-scan="pa_code">Scanner</button>
          </div>
        </div>

        <div class="row">
          <label>Photo principale</label>
          <div class="hstack">
            <button id="btnPaPhotoCam" type="button" class="btn">Cam√©ra</button>
            <button id="btnPaPhotoGal" type="button" class="btn">Galerie</button>
            <span id="pa_photo_label" class="muted">Aucune</span>
          </div>
          <input id="pa_photo_cam" type="file" accept="image/*" capture="environment" hidden />
          <input id="pa_photo_gal" type="file" accept="image/*" hidden />
          <input id="pa_photo_target" name="photo_principale" type="file" accept="image/*" hidden />
        </div>

        <fieldset>
          <legend>Questions</legend>

          <div class="qblock">
            <label>Cartons en bon √©tat ?</label>
            <div class="okko">
              <label><input type="radio" name="cartons_etat" value="OK" checked> OK</label>
              <label><input type="radio" name="cartons_etat" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="cartons_etat">
              <input type="file" data-photofor="cartons_etat" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="cartons_etat"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Intercalaires pr√©sents ?</label>
            <div class="okko">
              <label><input type="radio" name="intercalaires_cartons" value="OK" checked> OK</label>
              <label><input type="radio" name="intercalaires_cartons" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="intercalaires_cartons">
              <input type="file" data-photofor="intercalaires_cartons" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="intercalaires_cartons"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Ordre des cartons respect√© ?</label>
            <div class="okko">
              <label><input type="radio" name="ordre_cartons" value="OK" checked> OK</label>
              <label><input type="radio" name="ordre_cartons" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="ordre_cartons">
              <input type="file" data-photofor="ordre_cartons" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="ordre_cartons"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Cerclage bien appliqu√© ?</label>
            <div class="okko">
              <label><input type="radio" name="cerclage" value="OK" checked> OK</label>
              <label><input type="radio" name="cerclage" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="cerclage">
              <input type="file" data-photofor="cerclage" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="cerclage"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Palette stable ?</label>
            <div class="okko">
              <label><input type="radio" name="stabilite" value="OK" checked> OK</label>
              <label><input type="radio" name="stabilite" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="stabilite">
              <input type="file" data-photofor="stabilite" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="stabilite"></textarea>
            </div>
          </div>
        </fieldset>

        <div class="actions">
          <button class="btn primary" type="submit">üì§ Envoyer</button>
          <span class="result"></span>
        </div>
      </form>
    </section>

    <!-- PALETTES DESTINATION -->
    <section id="tab-Palettes_Destination" class="tab-pane">
      <h2>Contr√¥le des Palettes (Destination)</h2>
      <form class="qc-form" data-type="Palettes_Destination">
        <div class="row">
          <label>Date du jour</label>
          <input type="date" name="date_jour" required />
        </div>

        <div class="row">
          <label>Code-barres palette</label>
          <div class="hstack">
            <input id="pd_code" name="code_barres" type="text" required />
            <button type="button" class="btn" data-scan="pd_code">Scanner</button>
          </div>
        </div>

        <div class="row">
          <label>Photo principale</label>
          <div class="hstack">
            <button id="btnPdPhotoCam" type="button" class="btn">Cam√©ra</button>
            <button id="btnPdPhotoGal" type="button" class="btn">Galerie</button>
            <span id="pd_photo_label" class="muted">Aucune</span>
          </div>
          <input id="pd_photo_cam" type="file" accept="image/*" capture="environment" hidden />
          <input id="pd_photo_gal" type="file" accept="image/*" hidden />
          <input id="pd_photo_target" name="photo_principale" type="file" accept="image/*" hidden />
        </div>

        <fieldset>
          <legend>Questions</legend>

          <div class="qblock">
            <label>Cartons en bon √©tat ?</label>
            <div class="okko">
              <label><input type="radio" name="cartons_etat" value="OK" checked> OK</label>
              <label><input type="radio" name="cartons_etat" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="cartons_etat">
              <input type="file" data-photofor="cartons_etat" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="cartons_etat"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Cerclage bien appliqu√© ?</label>
            <div class="okko">
              <label><input type="radio" name="cerclage" value="OK" checked> OK</label>
              <label><input type="radio" name="cerclage" value="KO"> KO</label>
            </div>
            <div class="ko-extra" data-for="cerclage">
              <input type="file" data-photofor="cerclage" accept="image/*" capture="environment" multiple />
              <textarea data-commentfor="cerclage"></textarea>
            </div>
          </div>
        </fieldset>

        <div class="actions">
          <button class="btn primary" type="submit">üì§ Envoyer</button>
          <span class="result"></span>
        </div>
      </form>
    </section>

    <!-- KPI -->
    <section id="tab-KPI" class="tab-pane">
      <h2>Tableau de bord KPI</h2>
      <div class="kpi-filters">
        <input type="date" id="kpi_from">
        <input type="date" id="kpi_to">
        <button id="btnKpi" class="btn">Afficher</button>
        <button id="btnExport" class="btn">Export Excel</button>
      </div>
      <div id="kpiResults" class="kpi-results">‚Äî</div>
    </section>
  </main>

  <!-- LOADER -->
  <div id="appLoader" class="loader">
    <div class="loader-card">
      <div class="loader-text">Traitement‚Ä¶</div>
      <div class="loader-bar-wrap"><div class="loader-bar"></div></div>
      <div class="loader-percent">0%</div>
    </div>
  </div>

  <!-- MODAL SCANNER (iPhone OK) -->
  <div id="scannerModal" class="scanner-modal" style="display:none">
    <div class="scanner-box">
      <h3>Scanner le code-barres</h3>
      <video id="scannerVideo" playsinline autoplay muted></video>
      <div class="scanner-actions">
        <button id="scannerStart" class="btn primary">D√©marrer</button>
        <button id="scannerStop" class="btn">Arr√™ter</button>
        <button id="scannerClose" class="btn">Fermer</button>
      </div>
      <p class="hint">Astuce : visez bien, √©clairez la zone, distance 15‚Äì25 cm.</p>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
