<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pelichet QC â€” DIAG</title>
<meta name="theme-color" content="#ff6a00" />
<style>
:root{--bg:#0f1115;--card:#141821;--text:#f2f2f2;--muted:#b6bcc7;--border:#242a36;--primary:#ff6a00;--primaryText:#000}
:root[data-theme="light"]{--bg:#ffffff;--card:#f7f7f9;--text:#101318;--muted:#4c5563;--border:#e2e6ee;--primary:#ff6a00;--primaryText:#000}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.45 "Trebuchet MS",system-ui,Segoe UI,Roboto,Arial,sans-serif}
.topbar{display:flex;align-items:center;gap:.7rem;padding:.6rem 1rem;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:10}
.logo{width:36px;height:36px;border-radius:8px;background:#ff6a00}
h1{font-size:1.1rem;margin:0}
.icon-btn{margin-left:auto;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:.7rem;padding:.45rem .6rem;cursor:pointer}
.tabs{display:flex;gap:.4rem;padding:.5rem 1rem;border-bottom:1px solid var(--border);flex-wrap:wrap;background:var(--bg)}
.tab{border:1px solid var(--border);background:var(--card);color:var(--text);padding:.5rem .9rem;border-radius:.7rem;cursor:pointer}
.tab.active{background:var(--primary);color:var(--primaryText);border-color:transparent}
.container{max-width:980px;margin:0 auto;padding:1rem}
.tabContent{display:none}.tabContent.active{display:block}
.qcForm{display:grid;gap:1rem;background:var(--card);padding:1rem;border:1px solid var(--border);border-radius:1rem}
.row{display:grid;gap:.4rem}
.hstack{display:flex;gap:.5rem;align-items:center}
fieldset{border:1px solid var(--border);border-radius:.8rem;padding:.8rem 1rem}
legend{padding:0 .4rem;color:var(--muted)}
.qblock{display:grid;gap:.4rem;border-bottom:1px dashed var(--border);padding:.6rem 0}
.qblock:last-child{border-bottom:0}
.koDetails.hidden{display:none}
input[type="date"],input[type="text"],select,textarea,input[type="file"]{width:100%;padding:.6rem .7rem;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:.6rem}
textarea{min-height:84px}
.btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:.6rem .9rem;border-radius:.7rem;cursor:pointer}
.btn.primary{background:var(--primary);color:var(--primaryText);border-color:transparent}
.kpi-card{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:1rem;margin:.7rem 0}
.scanner-modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:99}
.scanner-box{width:min(520px,92vw);background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:1rem}
#scannerVideo{width:100%;height:auto;background:#000;border-radius:.6rem}
.scanner-actions{display:flex;gap:.5rem;margin-top:.6rem}
.hint{opacity:.8;font-size:.9rem;margin:.3rem 0 0}
@media(max-width:600px){.qcForm{padding:.8rem}.btn{padding:.55rem .75rem}}
/* Loader */
#globalLoader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:9999}
#globalLoader .box{background:#111;color:#fff;padding:14px 16px;border-radius:12px;min-width:220px;text-align:center}
#globalLoader .spin{width:28px;height:28px;border:3px solid #999;border-top-color:#ff6a00;border-radius:50%;margin:0 auto 8px;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>

<!-- Librairies -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>

<!-- Evite l'erreur 404 favicon (facultatif) -->
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>
<body>
  <header class="topbar">
    <div class="logo" aria-hidden="true"></div>
    <h1>Pelichet QC (Diag)</h1>
    <button id="themeToggle" class="icon-btn" title="Clair/Sombre">Light/Dark</button>
  </header>

  <nav class="tabs" id="tabs">
    <button class="tab active" data-target="tabCartons">Cartons</button>
    <button class="tab" data-target="tabPA">Palettes Avant</button>
    <button class="tab" data-target="tabPD">Palettes Destination</button>
    <button class="tab" data-target="tabKPI">KPI</button>
  </nav>

  <main class="container">
    <!-- CARTONS -->
    <section id="tabCartons" class="tabContent active">
      <h2>Controle des Cartons</h2>
      <form id="formCartons" class="qcForm" data-type="Cartons" autocomplete="off">
        <div class="row">
          <label>Date</label>
          <input type="date" name="date_saisie" required />
        </div>

        <div class="row">
          <label>Code-barres</label>
          <div class="hstack">
            <input id="cartons_code" name="code_barres" type="text" inputmode="numeric" required />
            <button type="button" class="btn" data-scan="cartons_code">Scanner</button>
          </div>
          <small>ou</small>
          <input type="file" class="barcode-photo" data-target="cartons_code" accept="image/*" capture="environment" />
        </div>

        <div class="row">
          <label>Photo principale</label>
          <input type="file" name="photo_principale" accept="image/*" capture="environment" />
        </div>

        <fieldset>
          <legend>Questions</legend>
          <div class="qblock">
            <label>Callage papier correct ?</label>
            <select name="callage_papier"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select>
            <div class="koDetails hidden">
              <input type="file" name="callage_papier_photos" accept="image/*" multiple />
              <textarea name="callage_papier_commentaire" placeholder="Decrire le probleme"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Intercalaires presents ?</label>
            <select name="intercalaires_livres"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select>
            <div class="koDetails hidden">
              <input type="file" name="intercalaires_livres_photos" accept="image/*" multiple />
              <textarea name="intercalaires_livres_commentaire" placeholder="Decrire le probleme"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Ordre & disposition respectes ?</label>
            <select name="ordre_colonnes"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select>
            <div class="koDetails hidden">
              <input type="file" name="ordre_colonnes_photos" accept="image/*" multiple />
              <textarea name="ordre_colonnes_commentaire" placeholder="Decrire le probleme"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Scotch bien applique ?</label>
            <select name="scotch"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select>
            <div class="koDetails hidden">
              <input type="file" name="scotch_photos" accept="image/*" multiple />
              <textarea name="scotch_commentaire" placeholder="Decrire le probleme"></textarea>
            </div>
          </div>

          <div class="qblock">
            <label>Livres depoussieres ?</label>
            <select name="depoussierage"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select>
            <div class="koDetails hidden">
              <input type="file" name="depoussierage_photos" accept="image/*" multiple />
              <textarea name="depoussierage_commentaire" placeholder="Decrire le probleme"></textarea>
            </div>
          </div>
        </fieldset>

        <button type="submit" class="btn primary">Envoyer (diag)</button>
      </form>
    </section>

    <!-- PALETTES AVANT -->
    <section id="tabPA" class="tabContent">
      <h2>Palettes (Avant camion)</h2>
      <form id="formPA" class="qcForm" data-type="Palettes_Avant" autocomplete="off">
        <div class="row"><label>Date</label><input type="date" name="date_saisie" required /></div>
        <div class="row">
          <label>Code-barres palette</label>
          <div class="hstack">
            <input id="pa_code" name="code_barres" type="text" required />
            <button type="button" class="btn" data-scan="pa_code">Scanner</button>
          </div>
          <small>ou</small>
          <input type="file" class="barcode-photo" data-target="pa_code" accept="image/*" capture="environment" />
        </div>
        <div class="row"><label>Photo principale</label><input type="file" name="photo_principale" accept="image/*" capture="environment" /></div>
        <fieldset><legend>Questions</legend>
          <div class="qblock"><label>Cartons en bon etat ?</label><select name="cartons_etat"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select><div class="koDetails hidden"><input type="file" name="cartons_etat_photos" accept="image/*" multiple /><textarea name="cartons_etat_commentaire"></textarea></div></div>
          <div class="qblock"><label>Intercalaires presents ?</label><select name="intercalaires_cartons"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select><div class="koDetails hidden"><input type="file" name="intercalaires_cartons_photos" accept="image/*" multiple /><textarea name="intercalaires_cartons_commentaire"></textarea></div></div>
          <div class="qblock"><label>Ordre des cartons respecte ?</label><select name="ordre_cartons"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select><div class="koDetails hidden"><input type="file" name="ordre_cartons_photos" accept="image/*" multiple /><textarea name="ordre_cartons_commentaire"></textarea></div></div>
          <div class="qblock"><label>Cerclage bien applique ?</label><select name="cerclage"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select><div class="koDetails hidden"><input type="file" name="cerclage_photos" accept="image/*" multiple /><textarea name="cerclage_commentaire"></textarea></div></div>
          <div class="qblock"><label>Palette stable ?</label><select name="stabilite"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select><div class="koDetails hidden"><input type="file" name="stabilite_photos" accept="image/*" multiple /><textarea name="stabilite_commentaire"></textarea></div></div>
        </fieldset>
        <button type="submit" class="btn primary">Envoyer (diag)</button>
      </form>
    </section>

    <!-- PALETTES DESTINATION -->
    <section id="tabPD" class="tabContent">
      <h2>Palettes (Destination)</h2>
      <form id="formPD" class="qcForm" data-type="Palettes_Destination" autocomplete="off">
        <div class="row"><label>Date</label><input type="date" name="date_saisie" required /></div>
        <div class="row">
          <label>Code-barres palette</label>
          <div class="hstack">
            <input id="pd_code" name="code_barres" type="text" required />
            <button type="button" class="btn" data-scan="pd_code">Scanner</button>
          </div>
          <small>ou</small>
          <input type="file" class="barcode-photo" data-target="pd_code" accept="image/*" capture="environment" />
        </div>
        <div class="row"><label>Photo principale</label><input type="file" name="photo_principale" accept="image/*" capture="environment" /></div>
        <fieldset><legend>Questions</legend>
          <div class="qblock"><label>Cartons en bon etat ?</label><select name="cartons_etat"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select><div class="koDetails hidden"><input type="file" name="cartons_etat_photos" accept="image/*" multiple /><textarea name="cartons_etat_commentaire"></textarea></div></div>
          <div class="qblock"><label>Cerclage bien applique ?</label><select name="cerclage"><option value="OK" selected>OK</option><option value="KO">Pas OK</option></select><div class="koDetails hidden"><input type="file" name="cerclage_photos" accept="image/*" multiple /><textarea name="cerclage_commentaire"></textarea></div></div>
        </fieldset>
        <button type="submit" class="btn primary">Envoyer (diag)</button>
      </form>
    </section>

    <!-- KPI -->
    <section id="tabKPI" class="tabContent">
      <h2>Tableau de bord KPI (diag)</h2>
      <div class="kpi-card">
        <p>Si cet onglet s'affiche au clic, la bascule d'onglets fonctionne.</p>
      </div>
    </section>
  </main>

  <!-- MODAL SCANNER -->
  <div id="scannerModal" class="scanner-modal" aria-hidden="true">
    <div class="scanner-box">
      <h3>Scanner le code-barres</h3>
      <video id="scannerVideo" playsinline autoplay muted></video>
      <div class="scanner-actions">
        <button id="scannerStart" class="btn primary" type="button">Demarrer</button>
        <button id="scannerStop" class="btn" type="button">Arreter</button>
        <button id="scannerClose" class="btn" type="button">Fermer</button>
      </div>
      <p class="hint">Autoriser la camera dans Safari/Chrome. Cadrez a 15-25 cm.</p>
    </div>
  </div>

  <!-- Loader -->
  <div id="globalLoader"><div class="box"><div class="spin"></div><div id="loaderMsg">Chargement...</div></div></div>

<script>
/*** CONFIG ***/
var CONFIG = {
  WEBAPP_BASE_URL: "https://script.google.com/macros/s/AKfycbyy826nPPtVW-HpyUSqzhJ-Eoq42_-rXhYHW3WXi3rT9cZ61dW264c7DDnfagnrXjM7/exec",
  RESIZE_ENABLED: true,
  MAX_IMAGE_DIM: 1600,
  OUTPUT_MIME: "image/jpeg",
  QUALITY: 0.85,
  MAX_FILE_SIZE_KB: 600
};
/*** HELPERS ***/
function qs(s,el){return (el||document).querySelector(s);}
function qsa(s,el){return Array.from((el||document).querySelectorAll(s));}
function todayStr(){var d=new Date();var p=function(n){return n<10?("0"+n):n;};return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());}
function on(el,ev,selOrFn,maybeFn){
  if(typeof selOrFn==="function"){el.addEventListener(ev,selOrFn);}
  else{el.addEventListener(ev,function(e){var t=e.target.closest(selOrFn); if(t){maybeFn(e,t);}});}
}
/*** THEME ***/
(function(){var t=localStorage.getItem("qc_theme")||"light";document.documentElement.setAttribute("data-theme",t);})();
qs("#themeToggle").addEventListener("click",function(){
  var c=document.documentElement.getAttribute("data-theme");
  var n=(c==="dark")?"light":"dark";
  document.documentElement.setAttribute("data-theme",n);
  localStorage.setItem("qc_theme",n);
});
/*** TABS ***/
on(qs("#tabs"),"click",".tab",function(e,btn){
  var target=btn.getAttribute("data-target");
  qsa(".tabs .tab").forEach(function(b){b.classList.toggle("active",b===btn);});
  qsa(".tabContent").forEach(function(s){s.classList.toggle("active",s.id===target);});
  console.log("[TAB]",target);
});
/*** DEFAULTS ***/
qsa('input[type="date"]').forEach(function(i){ if(!i.value) i.value=todayStr(); });
qsa("form.qcForm select").forEach(function(s){ if(!s.value) s.value="OK"; });
/*** KO UI ***/
on(document,"change",".qblock select",function(e,sel){
  var block=sel.closest(".qblock");
  var details=qs(".koDetails",block);
  if(!details) return;
  var isKO=(sel.value||"").toUpperCase()==="KO";
  details.classList.toggle("hidden",!isKO);
  qsa('input[type="file"]',details).forEach(function(f){ f.required=isKO; });
  var ta=qs("textarea",details); if(ta) ta.required=isKO;
});
/*** LOADER ***/
var _loader=0;
function showLoader(m){qs("#loaderMsg").textContent=m||"Chargement..."; qs("#globalLoader").style.display="flex"; _loader++; }
function hideLoader(){ _loader=Math.max(0,_loader-1); if(!_loader) qs("#globalLoader").style.display="none"; }
/*** ZXING helpers ***/
function getZXReader(){
  if(window.ZXingBrowser && ZXingBrowser.BrowserMultiFormatReader) return new ZXingBrowser.BrowserMultiFormatReader();
  if(window.ZXing && ZXing.BrowserMultiFormatReader) return new ZXing.BrowserMultiFormatReader();
  alert("ZXing non charge"); throw new Error("ZXing missing");
}
/*** SCANNER (live) ***/
var SCAN={stream:null,reader:null,target:null,running:false};
function openScannerFor(id){ SCAN.target=id; qs("#scannerModal").style.display="grid"; }
function startScanner(){
  (async function(){
    try{
      if(!SCAN.reader) SCAN.reader=getZXReader();
      var NS=(window.ZXingBrowser||window.ZXing);
      if(SCAN.reader.setHints){
        var hints=new Map();
        hints.set(NS.DecodeHintType.POSSIBLE_FORMATS,[NS.BarcodeFormat.EAN_13,NS.BarcodeFormat.CODE_128,NS.BarcodeFormat.CODE_39]);
        SCAN.reader.setHints(hints);
      }
      var v=qs("#scannerVideo"); v.setAttribute("playsinline","true"); v.muted=true;
      var st=await navigator.mediaDevices.getUserMedia({audio:false,video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}}});
      SCAN.stream=st; v.srcObject=st; await v.play(); SCAN.running=true;
      var loop=async function(){
        if(!SCAN.running) return;
        try{
          var res=await SCAN.reader.decodeOnceFromVideoDevice(undefined,"scannerVideo");
          var val=(res && (res.text || (res.getText&&res.getText()))) ? (res.text || res.getText()).trim() : "";
          if(val){
            var inp=document.getElementById(SCAN.target); if(inp) inp.value=val;
            closeScanner(); return;
          }
        }catch(err){}
        setTimeout(loop,250);
      };
      setTimeout(loop,250);
    }catch(e){
      alert("Camera non accessible: "+(e&&e.message?e.message:e));
      stopScanner();
    }
  })();
}
function stopScanner(){
  SCAN.running=false;
  try{ if(SCAN.reader && SCAN.reader.reset) SCAN.reader.reset(); }catch(err){}
  if(SCAN.stream){ SCAN.stream.getTracks().forEach(function(t){ try{t.stop();}catch(_){}}); SCAN.stream=null; }
}
function closeScanner(){ stopScanner(); qs("#scannerModal").style.display="none"; }
qs("#scannerStart").addEventListener("click",startScanner);
qs("#scannerStop").addEventListener("click",stopScanner);
qs("#scannerClose").addEventListener("click",closeScanner);
/*** Decode depuis image ***/
function fileToDataURL(file){ return new Promise(function(ok,ko){ var fr=new FileReader(); fr.onload=function(){ok(fr.result)}; fr.onerror=ko; fr.readAsDataURL(file); }); }
async function decodeBarcodeFromFile(inputEl, targetId){
  var f=inputEl.files && inputEl.files[0]; if(!f) return;
  try{
    var dataURL=await fileToDataURL(f);
    var img=new Image();
    await new Promise(function(ok,ko){ img.onload=ok; img.onerror=ko; img.src=dataURL; });
    var reader=getZXReader();
    var NS=(window.ZXingBrowser||window.ZXing);
    if(reader.setHints){
      var hints=new Map();
      hints.set(NS.DecodeHintType.POSSIBLE_FORMATS,[NS.BarcodeFormat.EAN_13,NS.BarcodeFormat.CODE_128,NS.BarcodeFormat.CODE_39]);
      reader.setHints(hints);
    }
    var res=await reader.decodeFromImage(img);
    var txt=(res && (res.text || (res.getText&&res.getText()))) ? (res.text || res.getText()).trim() : "";
    if(txt){ var target=document.getElementById(targetId); if(target) target.value=txt; }
    else alert("Aucun code-barres detecte sur l'image.");
  }catch(e){
    alert("Echec du decodage image: "+(e&&e.message?e.message:e));
  }
}
on(document,"change","input.barcode-photo",function(e,input){ decodeBarcodeFromFile(input, input.getAttribute("data-target")); });
/*** Boutons Scanner ***/
on(document,"click","button[data-scan]",function(e,btn){ openScannerFor(btn.getAttribute("data-scan")); });
/*** Envoi (diag) ***/
on(document,"submit","form.qcForm",function(e,form){
  e.preventDefault();
  alert('DIAG: formulaire "'+form.dataset.type+'" OK (UI).');
});
</script>
</body>
</html>
